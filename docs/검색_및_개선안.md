# 검색이 안 되는 이유 & 검색 가능하게 하기 · 7대 안전 · 개선 제안

## 1. 검색이 안 되는 이유

지도 화면의 **「주소 또는 장소 검색」** 기능은 네이버 지도 API의 **Geocoding(지오코딩)** 을 사용합니다.

### 1) Geocoder 서브모듈 미로드 (가장 흔한 원인)

- 네이버 지도 JavaScript API v3는 **기본 지도만** 로드하고, **주소→좌표 변환(Geocoding)** 은 **별도 서브모듈 `geocoder`** 로 제공됩니다.
- 지도 스크립트 URL에 `submodules=geocoder` 가 없으면 `naver.maps.Service.geocode()` 가 동작하지 않거나, 검색 시 오류/무반응이 발생할 수 있습니다.
- 이 프로젝트에서는 **지도 스크립트 URL에 `&submodules=geocoder` 를 추가**해 두었습니다. (아래 “검색 가능하게 하기” 참고)

### 2) 네이버 클라우드 플랫폼에서 Geocoding 미사용 등록

- [네이버 클라우드 플랫폼 콘솔](https://console.ncloud.com/) → **Application** → **Maps** 에서 해당 애플리케이션을 연 뒤,
- **사용 API** 에 **Geocoding**(주소→좌표), 필요 시 **Reverse Geocoding**(좌표→주소) 이 **선택되어 있는지** 확인해야 합니다.
- **Web Dynamic Map** 만 선택하고 Geocoding을 선택하지 않으면, 검색 시 429 등 오류가 나거나 결과가 나오지 않을 수 있습니다.

### 3) 사용 URL(도메인) 미등록

- Maps 애플리케이션의 **사용 URL** 에 실제로 접속하는 주소(예: `https://xxx.vercel.app`, `http://localhost:3080`)가 등록되어 있어야 합니다.
- 등록되지 않은 도메인에서는 지도/Geocoding 요청이 막힐 수 있어 검색이 동작하지 않습니다.

---

## 2. 검색을 가능하게 하는 방법

### (1) 코드 측 – 이미 반영됨

- **`lib/naver-map.ts`** 에서 지도 스크립트 URL을 다음처럼 수정해 두었습니다.
  - 기존: `...maps.js?ncpKeyId=클라이언트ID`
  - 수정: `...maps.js?ncpKeyId=클라이언트ID&submodules=geocoder`
- 이렇게 하면 지도 로드 시 **Geocoder 서브모듈**이 함께 로드되어, 검색 버튼으로 주소/장소 검색이 동작합니다.

### (2) 네이버 클라우드 플랫폼 설정

1. [네이버 클라우드 플랫폼](https://console.ncloud.com/) → **Application** → **Maps**
2. 사용 중인 **Application** 선택 (또는 새로 생성)
3. **사용 API** 에서 다음을 선택  
   - **Web Dynamic Map** (지도 표시)  
   - **Geocoding** (주소/장소 검색)  
   - (선택) **Reverse Geocoding** (좌표→주소, 지도에서 위치 선택 시 주소 표시용)
4. **사용 URL** 에 배포 주소·로컬 주소 추가  
   - 예: `https://안전지도웹앱-xxx.vercel.app`, `http://localhost:3080`
5. 저장 후, 한두 분 뒤부터 검색 동작 여부를 확인

### (3) 확인 방법

- 배포된 앱 또는 로컬에서 **안전점검 → 지도 보기** 로 들어간 뒤,
- 우측 상단 **검색** 버튼을 누르고 **주소 또는 장소** (예: "서울역", "종로3가")를 입력해 **이동** 버튼을 누릅니다.
- 지도가 해당 위치로 이동하면 Geocoding이 정상 동작하는 것입니다.

---

## 3. 안전의 종류를 7대 안전으로 변경

다음 **7대 안전** 으로 통일해 두었습니다.

| 구분 | 항목 |
|------|------|
| 1 | 생활안전 |
| 2 | 교통안전 |
| 3 | 응급처치 |
| 4 | 폭력예방 및 신변보호 |
| 5 | 약물 및 사이버 중독 예방 |
| 6 | 재난안전 |
| 7 | 직업안전 |

### 반영된 곳

- **타입**: `types/index.ts` — `SafetyCategory` 타입 및 `SAFETY_CATEGORIES` 상수
- **DB**: `supabase-schema.sql` — `safety_pins.category` CHECK 제약조건 (신규 설치용)
- **UI**:  
  - 안전점검 시 카테고리 선택 (PinForm, 지도 모달)  
  - 리스트/상세/내 핀 목록의 카테고리 아이콘·색상  
- **지도 마커 색상**: `components/Map/NaverMap.tsx` — 7대 안전별 색상 매핑

### 이미 Supabase를 사용 중인 경우 (기존 DB)

- 기존에는 `category` 가 `'교통', '생활안전', '환경', '기타'` 로 제한되어 있을 수 있습니다.
- **7대 안전**으로 바꾸려면 **마이그레이션**이 필요합니다.  
  - `docs/supabase-migration-7대안전.sql` (같은 폴더에 생성해 두었을 수 있음) 또는  
  - Supabase SQL Editor에서 `safety_pins` 의 `category` CHECK를 삭제한 뒤, 새 CHECK로 추가하고,  
    기존 데이터는 `교통`→`교통안전`, `생활안전`→`생활안전`, `환경`→`재난안전`, `기타`→`생활안전` 등으로 매핑해 업데이트하는 SQL을 실행해야 합니다.
- **신규 설치**라면 `supabase-schema.sql` 을 그대로 실행하면 7대 안전이 적용됩니다.

---

## 4. 개선점과 방향 제안

### (1) 검색·지도 UX

- **검색어 자동완성**: 현재는 입력 후 “이동” 버튼을 눌러야 검색됩니다. 네이버 Places API 또는 Geocoding 연동 **자동완성**을 넣으면, “서울역”, “강남역”처럼 입력 중에 추천 목록을 보여 줄 수 있습니다.
- **최근 검색/즐겨찾기**: 자주 쓰는 장소를 저장해 한 번에 이동할 수 있게 하면 교사·학생 모두 편리합니다.
- **검색 실패 시 안내**: “검색 결과를 찾을 수 없습니다”일 때, “주소나 건물명으로 다시 검색해 보세요” 같은 짧은 안내 문구를 추가하면 좋습니다.

### (2) 7대 안전 활용

- **필터/통계**: 리스트·지도에서 **7대 안전별 필터**를 두어, “교통안전만 보기”, “재난안전만 보기” 등으로 볼 수 있게 하면 교육 활용도가 올라갑니다.
- **학급/학교 단위 요약**: 학급·학교별로 7대 안전 항목별 등록 개수를 집계해 “우리 반은 교통안전·생활안전이 많다” 같은 인사이트를 보여 줄 수 있습니다.
- **교육 자료 연계**: 각 카테고리별로 교육부·교육청 등에서 제공하는 안전 교육 자료 링크나 짧은 설명을 붙이면, 핀만 보고도 학습으로 이어지게 할 수 있습니다.

### (3) 접근성·사용성

- **모바일 터치**: 지도 위 버튼(검색, 내 위치) 크기를 조금 더 키우고, 터치 영역을 넓히면 스마트폰에서 쓰기 편해집니다.
- **키보드/스크린리더**: 검색 입력창에 적절한 `label`·`aria-label`, 포커스 순서를 맞추면 접근성이 좋아집니다.
- **오프라인/느린 네트워크**: 지도 로딩 실패 시 “네트워크를 확인해 주세요” 메시지와 재시도 버튼을 두면 안정성이 올라갑니다.

### (4) 데이터·운영

- **이미지 압축**: 사진 업로드 전에 리사이즈/압축을 하면 저장 공간과 로딩 속도 모두 개선됩니다.
- **신고/피드백 상태**: “검토 중 / 조치 완료” 같은 상태를 두면 교사가 어떤 핀에 피드백을 했는지 관리하기 쉽습니다.
- **알림(선택)**: 새 핀·새 피드백이 올라왔을 때 이메일 또는 앱 푸시로 알려 주는 기능을 나중에 붙일 수 있습니다.

### (5) 보안·정책

- **사진/내용 검토**: 학생이 올린 사진·설명이 부적절할 수 있으므로, 교사 승인 후 공개되게 하거나, 신고 버튼을 두는 방안을 고려할 수 있습니다.
- **개인정보**: 주소·위치가 지나치게 상세하지 않도록, 저장 시 동 단위로만 저장하거나, 공개 범위를 학급 내로 제한하는 정책을 유지하는 것이 좋습니다.

---

## 5. 교육자료 링크 넣는 방법

- **파일 위치**: `data/safety-education-links.ts`
- **방법**: 7대 안전별로 `{ title: "제목", url: "https://..." }` 형태로 배열에 추가하면 됩니다.
- 안전교육 관련 링크를 검색해서 보내주시면, 해당 파일에 반영하는 방식으로 연계할 수 있습니다.
- 링크가 들어간 카테고리는 **리스트 보기**(7대 안전 필터 선택 시)와 **핀 상세 페이지**에서 「이 카테고리 교육자료」로 노출됩니다.

---

## 6. 반영된 개선 사항 (요약)

- **리스트 7대 안전 필터**: 리스트 보기에서 장소(학교/집/마을) + 7대 안전별 필터로 목록 조회
- **교육자료 연계**: `data/safety-education-links.ts` 에 링크 추가 시, 해당 카테고리에서 자동 노출
- **지도 검색**: 최근 검색(최대 10개)·즐겨찾기(현재 위치 저장) 지원, localStorage 사용
- **지도 줌**: 지도 왼쪽에 +/- 확대·축소 컨트롤 표시 (기본 켜짐, `showZoomControl` prop으로 제어 가능)

---

이 문서는 **검색이 안 되는 이유**, **검색을 가능하게 하는 방법**, **7대 안전 적용**, **교육자료 링크**, **반영된 개선 사항**을 정리한 것입니다.  
추가로 반영하고 싶은 항목이 있으면 요구사항에 맞춰 단계별로 적용하면 됩니다.
